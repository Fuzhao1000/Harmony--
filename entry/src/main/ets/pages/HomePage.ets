import router from '@ohos.router';
import file from '@ohos.file.picker';
import * as picker from '@ohos.file.picker';
import photoAccessHelper from '@ohos.file.photoAccessHelper';
import { BusinessError } from '@ohos.base';
import image from '@ohos.multimedia.image';

interface PostItem {
  baname:string
  user: string
  time: string
  content: string
  image?: string
  likes: number
  comments: number
}

interface ForumItem {
  baname: string      // å§å
  members: number     // æˆå‘˜æ•°é‡
  posts: number       // å¸–å­æ•°é‡
  icon: Resource      // å§å¤´åƒï¼ˆå›¾ç‰‡èµ„æºï¼‰
}

interface UserItem{
  username:string,
  tx:Resource,
  gz:number,
  fans:number,
  phone:number
}

@Entry
@Component
struct HomePage {
  @State currentTab: string = 'home';
  @State isEditing: boolean = false;
  @State userName:string = '';
  @State headImage:string ='app.media.head';
  @State likesClicked: boolean = false;
  @StorageLink('posts') posts: PostItem[] = []

  @State forums: ForumItem[] = [
    {
      baname: "æµ™æ±Ÿå†œæž—å¤§å­¦å§",
      members: 0,
      posts: 1,
      icon: $r('app.media.zjnldx')
    },
    {
      baname: "æ˜Žæ—¥æ–¹èˆŸå§",
      members: 0,
      posts: 1,
      icon: $r('app.media.mrfz')
    },
    {
      baname: "bilibiliå§",
      members: 0,
      posts: 1,
      icon: $r('app.media.bilibili')
    }
  ]

  async pickImageFromGallery() {
    try {
      const photoPicker = new photoAccessHelper.PhotoViewPicker();
      // æ‰“å¼€ç›¸å†Œï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
      const selectResult = await photoPicker.select({
        MIMEType: photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE, // ä»…é€‰å›¾ç‰‡
        maxSelectNumber: 1
      });

      if (selectResult && selectResult.photoUris.length > 0) {
        // èŽ·å–é€‰ä¸­å›¾ç‰‡çš„ URI
        const uri = selectResult.photoUris[0];
        console.log("é€‰æ‹©çš„å›¾ç‰‡åœ°å€ï¼š" + uri);

        // æ›´æ–°å¤´åƒæ˜¾ç¤º
        this.headImage = uri;
      }
    } catch (err) {
      const error = err as BusinessError;
      console.error(`é€‰å›¾å¤±è´¥ï¼š${error.code} - ${error.message}`);
    }
  }

  aboutToAppear() {
    if (!this.posts || this.posts.length === 0) {
      this.posts = [
        { baname:'æµ™æ±Ÿå†œæž—å¤§å­¦å§', user: 'ç”¨æˆ·1', time: '1å°æ—¶å‰', content: 'è¿™æ˜¯ç¬¬ä¸€æ¡å¸–å­å†…å®¹ã€‚', image: 'app.media.bj2', likes: 0, comments: 0 },
        { baname:'æ˜Žæ—¥æ–¹èˆŸå§', user: 'ç”¨æˆ·2', time: '2å°æ—¶å‰', content: 'ä»Šå¤©å¿ƒæƒ…ä¸é”™ï½ž', image: '', likes: 0, comments: 0 },
        { baname:'bilibiliå§', user: 'ç”¨æˆ·2', time: '3å°æ—¶å‰', content: 'æœ‰äººå—', image: 'app.media.tutu', likes: 0, comments: 0 },
      ]

      try {
        PersistentStorage.persistProp('posts',[])
      } catch (e) {
        console.warn('PersistentStorage.persistProp å¯èƒ½åœ¨å½“å‰çŽ¯å¢ƒä¸å¯ç”¨ï¼š', e)
      }
    }
  }

  addPost() {
    const newPost: PostItem = {
      baname:'æµ™æ±Ÿå†œæž—å¤§å­¦å§',

      user: `ç”¨æˆ·${this.posts.length + 1}`,
      time: 'åˆšåˆš',
      content: `è¿™æ˜¯ç¬¬${this.posts.length + 1}æ¡å¸–å­ï¼ˆæ¥è‡ª StorageLinkï¼‰`,
      image: 'app.media.bj2',
      likes: 0,
      comments: 0
    }
    // åœ¨æ•°ç»„å¤´éƒ¨æ’å…¥
    this.posts.unshift(newPost)

    try {
      PersistentStorage.persistProp('posts',[])
    } catch (e) {
      console.warn('PersistentStorage.persistProp å¤±è´¥ï¼š', e)
    }
  }

  build() {
    Stack() {
      // èƒŒæ™¯å›¾
      Image($r('app.media.bj2'))
        .objectFit(ImageFit.Cover)
        .width('100%')
        .height('120%')


      Column({ space: 30 }) {
        // é¡¶éƒ¨æœç´¢æ¡†
        if (this.currentTab === 'home') {
          Row() {
            Image($r('app.media.icon_search'))
              .width(24)
              .height(24)
              .margin({ left: 10 })

            Text("åœ¨æ­¤è¾“å…¥")
              .fontColor('#AAAAAA')
              .fontSize(16)

            Text("æœç´¢")
              .fontColor('#007AFF')
              .fontSize(16)
              .margin({ right: 10 })
          }
          .width('95%')
          .height(40)
          .borderRadius(25)
          .backgroundColor(Color.White)
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.SpaceBetween)
          .margin({ top: -0 })

          // ä¸­é—´ç™½æ¡†å ä½
          Column() {

            Scroll() {
              Column({ space: 16 }) {
                // ç”¨ StorageLink ç»‘å®šçš„ this.posts æ¥æ¸²æŸ“
                ForEach(this.posts, (post: PostItem) => {
                  Column() {
                    // å¸–å­å¤´éƒ¨
                    Row({ space: 10 }) {

                        Image(this.forums.find(b => b.baname === post.baname)?.icon)
                          .width(40)
                          .height(40)
                          .borderRadius(20)

                          .margin({ right: 10 })

                        Text(post.baname)
                          .fontSize(16)
                          .fontColor(Color.Black)
                          .fontWeight(FontWeight.Medium)
                          .margin({
                            top: 8,
                            bottom: 8,
                            right: 15,
                            left: -8
                          })

                    }

                    Row({ space: 2 }) {
                      Image($r('app.media.head'))
                        .width(40)
                        .height(40)
                        .borderRadius(20)
                        .backgroundColor('#CCCCCC')

                      Column({ space: 2 }) {
                        Text(post.user).fontSize(15).fontWeight(FontWeight.Medium).fontColor(Color.Black)
                        Text(post.time).fontSize(12).fontColor('#999999')
                      }.alignItems(HorizontalAlign.Start)
                    }
                    // å†…å®¹
                    Text(post.content)
                      .fontSize(14)
                      .fontColor(Color.Black)
                      .margin({ top: 8, bottom: 8 })

                    // å›¾ç‰‡ï¼ˆæœ‰çš„è¯æ˜¾ç¤ºï¼‰
                    Image($r(post.image ?? null))
                        .width('100%')
                        .height(post.image ? 180 : 0)
                        .borderRadius(12)
                        .objectFit(ImageFit.Cover)


                    // æ“ä½œæ 
                    Row({ space: 75 }) {

                      Text(this.likesClicked ? `ðŸ‘ ç‚¹èµž${post.likes}` : `ðŸ‘ ç‚¹èµž${post.likes}`)
                        .fontColor('#666666')
                        .fontSize(13)
                        .onClick(() => {
                          if(!this.likesClicked) // åˆ‡æ¢çŠ¶æ€
                          {
                            post.likes+=1
                            this.likesClicked=!this.likesClicked
                          }
                          else{
                            post.likes-=1
                            this.likesClicked=!this.likesClicked
                          }

                        })
                      Text(`ðŸ’¬ è¯„è®º${post.comments}`).fontColor('#666666').fontSize(13)
                      Text('â†— åˆ†äº«').fontColor('#666666').fontSize(13)
                    }.margin({ top: 8 })
                  }
                  .padding(12)
                  .backgroundColor('#F9F9F9')
                  .borderRadius(16)
                  .shadow({ radius: 2, color: '#22000000', offsetX: 0, offsetY: 2 })

                  .alignItems(HorizontalAlign.Start)
                })
              }
              .width('100%')
              .padding({ top: 10, bottom: 20 })
            }
            .width('95%')
            .height('100%')
          }
          .width('95%')
          .height(612)
          .borderRadius(25)
          .backgroundColor(Color.White)
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Start)
          .margin({ top: -10 })



        }
        else if (this.currentTab === 'profile') {
          Column() {
            Text("ä¸ªäººä¿¡æ¯").fontSize(27).fontColor(Color.Black).margin({top:-20})
            Column() {
              if (this.isEditing){
                Image($r(this.headImage))
                  .width(100)
                  .height(100)
                  .borderRadius(50)
                  .margin({ top: -190 })
                  .onClick(() => {
                    if (this.isEditing) {
                      this.pickImageFromGallery()
//ä¸ä¼šåšç›¸å†Œé€‰æ‹©å›¾ç‰‡

                    }
                  })
              }
              else
              {
                Image($r('app.media.head'))  // å¤´åƒèµ„æº
                  .width(100)
                  .height(100)
                  .borderRadius(50)  // åœ†å½¢
                  .margin({ top: -190 })
              }
              if (this.isEditing) {
                TextInput()

                  .width(200)
                  .height(40)
                  .fontSize(22)
                  .fontColor(Color.Black)
                  .onChange((value) => {
                    this.userName = value
                  })
                  .margin({ top: 10 })
              }
              else
              {
                Text(this.userName?this.userName:"é»˜è®¤ç”¨æˆ·")
                  .fontSize(22)
                  .fontColor(Color.Black)
                  .margin({ top: 10 })
              }



              // 4ï¸âƒ£ è“æ¡†ç™½å­—â€œç¼–è¾‘â€æŒ‰é’®
               Text(this.isEditing ? "ä¿å­˜" : "ç¼–è¾‘")
                .fontSize(18)
                .fontColor(Color.White)
                .width(120)
                .height(40)
                .borderRadius(20)
                .backgroundColor(this.isEditing ?'#FF0000':'#007AFF')
                .textAlign(TextAlign.Center)

                .margin({ top: 20 })
                .onClick(() => {
                  this.isEditing = !this.isEditing
                })
              Row({ space: 30}) {
                Column() {
                  Text("å…³æ³¨").fontSize(16).fontColor(Color.Gray)
                  Text("0").fontSize(18).fontColor(Color.Black)
                }

                Column() {
                  Text("ç²‰ä¸").fontSize(16).fontColor(Color.Gray)
                  Text("0").fontSize(18).fontColor(Color.Black)
                }
              }
              .margin({ top: 10 })
            }
            .width('95%')
            .height('calc(115% - 100px)')
            .borderRadius(25)
            .backgroundColor(Color.White)
            .alignItems(HorizontalAlign.Center)
            .justifyContent(FlexAlign.Center)
            .margin({ top: 30 })


            Row() {
              Column() {
                Text("é¦–é¡µ").fontSize(27).fontColor(Color.Black)
                  .onClick(() => {
                    this.currentTab = 'home'
                  })
              }

              Column() {
                Text("è¿›å§").fontSize(27).fontColor(Color.Black)
                  .onClick(() => {
                    this.currentTab = 'forum'
                  })
              }

              Column() {
                Text("å‘å¸ƒ").fontSize(27).fontColor(Color.Black)
              }

              Column() {
                Text("æ¶ˆæ¯").fontSize(27).fontColor(Color.Black)
              }

              Column() {
                Text("æˆ‘çš„").fontSize(27).fontColor(Color.Blue)
                  .onClick(() => {
                    this.currentTab = 'profile'
                  })
              }
            }
            .width('100%')
            .height(75)
            .backgroundColor('#F5F5F5')
            .justifyContent(FlexAlign.SpaceAround)

          }
        }
        else if (this.currentTab === 'forum') {
          Column() {
            Text("æ‰€æœ‰çš„å§")
              .fontSize(27)
              .fontColor(Color.Black)
              .margin({ top: 10, bottom: 10 })

            // ä½¿ç”¨ Scroll åŒ…è£¹æ•´ä¸ªå§åˆ—è¡¨
            // ä½¿ç”¨ Scroll åŒ…è£¹æ•´ä¸ªå§åˆ—è¡¨
            Scroll() {
              Column({ space: 16 }) {
                ForEach(this.forums, (forum: ForumItem) => {
                  Row() {
                    // å§å¤´åƒ
                    Image(forum.icon)
                      .width(70)
                      .height(70)
                      .borderRadius(12)
                      .margin({ right: 12 })

                    // å§æ–‡å­—ä¿¡æ¯
                    Column({ space: 4 }) {
                      Text(forum.baname)
                        .fontSize(18)
                        .fontColor(Color.Black)
                        .fontWeight(FontWeight.Medium)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })

                      Text(`${forum.posts} å¸–å­ Â· ${forum.members} æˆå‘˜`)
                        .fontSize(14)
                        .fontColor('#666666')
                    }
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Start)
                    .width('100%')
                  }
                  .width('92%') // ðŸ‘ˆ ä¸€è¡Œä¸€ä¸ªå§ï¼Œæ•´ä½“æ›´å®½
                  .height(90)
                  .padding({ left: 12, right: 12 })
                  .backgroundColor(Color.White)
                  .borderRadius(14)
                  .shadow({ radius: 3, color: '#22000000', offsetX: 0, offsetY: 2 })
                  .onClick(() => {

                    // è·³è½¬åˆ°å§è¯¦æƒ…é¡µé€»è¾‘
                  })
                })
              }
              .padding({ top: 10, left: 16, right: 16, bottom: 16 })
            }
            .width('100%')
            .height('100%')
            .backgroundColor('#F5F5F5')


            // åº•éƒ¨å¯¼èˆªæ 
            Row() {
              Column() { Text("é¦–é¡µ").fontSize(27).fontColor(Color.Black)
                .onClick(() => this.currentTab = 'home')
              }
              Column() { Text("è¿›å§").fontSize(27).fontColor(Color.Blue)
                .onClick(() => this.currentTab = 'forum')
              }
              Column() { Text("å‘å¸ƒ").fontSize(27).fontColor(Color.Black) }
              Column() { Text("æ¶ˆæ¯").fontSize(27).fontColor(Color.Black) }
              Column() { Text("æˆ‘çš„").fontSize(27).fontColor(Color.Black)
                .onClick(() => this.currentTab = 'profile')
              }
            }
            .width('100%')
            .height(60)
            .backgroundColor('#F5F5F5')
            .justifyContent(FlexAlign.SpaceAround)
            .alignItems(VerticalAlign.Center)
            .margin({top:75})
          }
        }

        if (this.currentTab === 'home')
          Row() {
            Column() {
              Text("é¦–é¡µ").fontSize(27).fontColor(Color.Blue)
                .onClick(() => {
                  this.currentTab = 'home'
                })
            }

            Column() {
              Text("è¿›å§").fontSize(27).fontColor(Color.Black)
                .onClick(() => {
                  this.currentTab = 'forum'
                })
            }

            Column() {
              Text("å‘å¸ƒ").fontSize(27).fontColor(Color.Black)
            }

            Column() {
              Text("æ¶ˆæ¯").fontSize(27).fontColor(Color.Black)
            }

            Column() {
              Text("æˆ‘çš„").fontSize(27).fontColor(Color.Black)
                .onClick(() => {
                  this.currentTab = 'profile'
                })
            }
          }
          .width('100%')
          .height(51)
          .backgroundColor('#F5F5F5')

          .justifyContent(FlexAlign.SpaceAround)
          .padding({ top: -30 })

      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('80%')

  }

}

