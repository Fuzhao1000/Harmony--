import router from '@ohos.router';
import file from '@ohos.file.picker';
import * as picker from '@ohos.file.picker';
import photoAccessHelper from '@ohos.file.photoAccessHelper';
import { BusinessError } from '@ohos.base';
import { common } from '@kit.AbilityKit';
import {loadUserInfo} from '../pages/LoginPage';
import { saveUserName} from '../pages/LoginPage';
import image from '@ohos.multimedia.image';
import http from '@ohos.net.http';
import util from '@ohos.util';
import preferences from '@ohos.data.preferences'

import fs from '@ohos.file.fs';

interface PostItem {
  baname:string
  user: string
  time: string
  content: string
  image?: string
  likes: number
  comments: number
}

interface ForumItem {
  baname: string      // å§å
  members: number     // æˆå‘˜æ•°é‡
  posts: number       // å¸–å­æ•°é‡
  icon: Resource      // å§å¤´åƒï¼ˆå›¾ç‰‡èµ„æºï¼‰
}

interface UserItem{
  username:string,
  tx:Resource,
  gz:number,
  fans:number,
  phone:number
}

interface UpdateNameResponse {
  success: boolean;
  message?: string;
}



@Entry
@Component
struct HomePage {
  @State currentTab: string = 'home';
  @State isEditing: boolean = false;
  @State userName:string = '';
  @State headImage:string ='app.media.head';
  @State likesClicked: boolean = false;
  @State content: string = ''
  @State selectedBa: string = ''
  @State selectedForum: string = ''
  @State selectedImage: string = ''
  @StorageLink('posts') posts: PostItem[] = []
  @State loading: boolean = false;

  @State forums: ForumItem[] = [
    {
      baname: "æµ™æ±Ÿå†œæ—å¤§å­¦å§",
      members: 0,
      posts: 1,
      icon: $r('app.media.zjnldx')
    },
    {
      baname: "æ˜æ—¥æ–¹èˆŸå§",
      members: 0,
      posts: 1,
      icon: $r('app.media.mrfz')
    },
    {
      baname: "bilibiliå§",
      members: 0,
      posts: 1,
      icon: $r('app.media.bilibili')
    },
  {
  baname: "åŠ¨æ¼«å§",
  members: 0,
  posts: 0,
  icon: $r('app.media.dm')
  },
    {
      baname: "å¼±æ™ºå§",
      members: 0,
      posts: 0,
      icon: $r('app.media.rz')
    }
  ]

  async pickImageFromGallery() {
    try {
      const photoPicker = new photoAccessHelper.PhotoViewPicker();
      // æ‰“å¼€ç›¸å†Œï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
      const selectResult = await photoPicker.select({
        MIMEType: photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE, // ä»…é€‰å›¾ç‰‡
        maxSelectNumber: 1
      });

      if (selectResult && selectResult.photoUris.length > 0) {
        // è·å–é€‰ä¸­å›¾ç‰‡çš„ URI
        const uri = selectResult.photoUris[0];
        console.log("é€‰æ‹©çš„å›¾ç‰‡åœ°å€ï¼š" + uri);

        // æ›´æ–°å¤´åƒæ˜¾ç¤º
        this.headImage = uri;
      }
    } catch (err) {
      const error = err as BusinessError;
      console.error(`é€‰å›¾å¤±è´¥ï¼š${error.code} - ${error.message}`);
    }
  }

  async pickImageForPost() {
    try {
      const photoPicker = new photoAccessHelper.PhotoViewPicker();
      // æ‰“å¼€ç›¸å†Œï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
      const selectResult = await photoPicker.select({
        MIMEType: photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE, // ä»…é€‰å›¾ç‰‡
        maxSelectNumber: 1
      });

      if (selectResult && selectResult.photoUris.length > 0) {
        // è·å–é€‰ä¸­å›¾ç‰‡çš„ URI
        const uri = selectResult.photoUris[0];
        console.log("é€‰æ‹©çš„å¸–å­å›¾ç‰‡åœ°å€ï¼š" + uri);

        // æ›´æ–°å¸–å­å›¾ç‰‡æ˜¾ç¤º
        this.selectedImage = uri;
      }
    } catch (err) {
      const error = err as BusinessError;
      console.error(`é€‰å›¾å¤±è´¥ï¼š${error.code} - ${error.message}`);
    }
  }

  aboutToAppear() {
    if (!this.posts || this.posts.length === 0) {
      this.posts = [
        { baname:'æµ™æ±Ÿå†œæ—å¤§å­¦å§', user: 'ç”¨æˆ·1', time: '1å°æ—¶å‰', content: 'è¿™æ˜¯ç¬¬ä¸€æ¡å¸–å­å†…å®¹ã€‚', image: 'app.media.bj2', likes: 0, comments: 0 },
        { baname:'æ˜æ—¥æ–¹èˆŸå§', user: 'ç”¨æˆ·2', time: '2å°æ—¶å‰', content: 'ä»Šå¤©å¿ƒæƒ…ä¸é”™ï½', image: '', likes: 0, comments: 0 },
        { baname:'bilibiliå§', user: 'ç”¨æˆ·2', time: '3å°æ—¶å‰', content: 'æœ‰äººå—', image: 'app.media.tutu', likes: 0, comments: 0 },
      ]

      try {
        PersistentStorage.persistProp('posts',[])
      } catch (e) {
        console.warn('PersistentStorage.persistProp å¯èƒ½åœ¨å½“å‰ç¯å¢ƒä¸å¯ç”¨ï¼š', e)
      }
    }
  }

 async  publishPost(
  baname: string,
  user: string,
  content: string,
  image?: string
): Promise<PostItem | null> {
  const httpRequest = http.createHttp();

  try {

    // å‘é€ POST è¯·æ±‚
    const response = await httpRequest.request(
      'http://10.205.218.246:8080/posts',
      {
        method: http.RequestMethod.POST,
        header: { 'Content-Type': 'application/json' },
        extraData: JSON.stringify({ baname, user, content, image })
      }
    );

    // è§£æå“åº”
    const text =
      typeof response.result === 'string'
        ? response.result
        : new util.TextDecoder('utf-8').decode(response.result as Uint8Array);

    const data = JSON.parse(text) as PostItem;

    return data;
  } catch (e) {
    console.error('å‘å¸–å¤±è´¥', e);
    return null;
  } finally {
    httpRequest.destroy();
  }
}

  async onPublishClick() {
    if (!this.selectedBa || this.content.length === 0) return;

    const newPost = await this.publishPost(
      this.selectedBa,
      this.userName,
      this.content,
      this.selectedImage // å¯é€‰
    );

    if (newPost) {
      this.posts.push(newPost);

      // æ¸…ç©ºçŠ¶æ€
      this.content = '';
      this.selectedBa = '';
      this.selectedImage = '';
    }
  }

  private async loadUserNameFromDB() {
    this.loading = true;
    const currentContext = this.getUIContext().getHostContext() as common.UIAbilityContext;
    const userInfo = await loadUserInfo(currentContext);
    const userId: number = parseInt(userInfo.id, 10) || 0;

    if (!userId) {
      console.error("æœªç™»å½•æˆ–ç”¨æˆ·IDä¸¢å¤±");
      this.loading = false;
      return;
    }

    const httpRequest = http.createHttp();
    try {
      const response = await httpRequest.request(
        `http://10.205.218.246:8080/api/user/${userId}`,  // GET ç”¨æˆ·åç«¯ç‚¹
        {
          method: http.RequestMethod.GET,
          header: { "Content-Type": "application/json" }
          // å¦‚æœéœ€è¦è®¤è¯ï¼ŒåŠ  token header
        }
      );

      let text = typeof response.result === "string"
        ? response.result
        : new util.TextDecoder("utf-8").decode(response.result as Uint8Array);

      const data = JSON.parse(text) as { success: boolean; name: string };
      if (data.success) {
        this.userName = data.name || "é»˜è®¤ç”¨æˆ·";
        await saveUserName(this.userName, this.getUIContext().getHostContext() as common.UIAbilityContext);  // åŒæ­¥æœ¬åœ°
      } else {
        this.userName = "é»˜è®¤ç”¨æˆ·";
      }
      console.log("åŠ è½½ç”¨æˆ·åç»“æœ:", text);
    } catch (e) {
      console.error('åŠ è½½ç”¨æˆ·åå¤±è´¥:', e);
      this.userName = "é»˜è®¤ç”¨æˆ·";
    } finally {
      httpRequest.destroy();
      this.loading = false;
    }
  }

  build() {
    Stack() {
      // èƒŒæ™¯å›¾
      Image($r('app.media.bj2'))
        .objectFit(ImageFit.Cover)
        .width('100%')
        .height('120%')


      Column({ space: 30 }) {
        // é¡¶éƒ¨æœç´¢æ¡†
        if (this.currentTab === 'home') {
          Row() {
            Image($r('app.media.icon_search'))
              .width(24)
              .height(24)
              .margin({ left: 10 })

            Text("åœ¨æ­¤è¾“å…¥")
              .fontColor('#AAAAAA')
              .fontSize(16)

            Text("æœç´¢")
              .fontColor('#007AFF')
              .fontSize(16)
              .margin({ right: 10 })
          }
          .width('95%')
          .height(40)
          .borderRadius(25)
          .backgroundColor(Color.White)
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.SpaceBetween)
          .margin({ top: -0 })

          // ä¸­é—´ç™½æ¡†å ä½
          Column() {

            Scroll() {
              Column({ space: 16 }) {
                // ç”¨ StorageLink ç»‘å®šçš„ this.posts æ¥æ¸²æŸ“
                ForEach(this.posts, (post: PostItem) => {
                  Column() {
                    // å¸–å­å¤´éƒ¨
                    Row({ space: 10 }) {

                        Image(this.forums.find(b => b.baname === post.baname)?.icon)
                          .width(40)
                          .height(40)
                          .borderRadius(20)

                          .margin({ right: 10 })

                        Text(post.baname)
                          .fontSize(16)
                          .fontColor(Color.Black)
                          .fontWeight(FontWeight.Medium)
                          .margin({
                            top: 8,
                            bottom: 8,
                            right: 15,
                            left: -8
                          })

                    }

                    Row({ space: 2 }) {
                      Image($r('app.media.head'))
                        .width(40)
                        .height(40)
                        .borderRadius(20)
                        .backgroundColor('#CCCCCC')

                      Column({ space: 2 }) {
                        Text(post.user).fontSize(15).fontWeight(FontWeight.Medium).fontColor(Color.Black)
                        Text(post.time).fontSize(12).fontColor('#999999')
                      }.alignItems(HorizontalAlign.Start)
                    }
                    // å†…å®¹
                    Text(post.content)
                      .fontSize(14)
                      .fontColor(Color.Black)
                      .margin({ top: 8, bottom: 8 })

                    // å›¾ç‰‡ï¼ˆæœ‰çš„è¯æ˜¾ç¤ºï¼‰
                    Image($r(post.image ?? null))
                        .width('100%')
                        .height(post.image ? 180 : 0)
                        .borderRadius(12)
                        .objectFit(ImageFit.Cover)


                    // æ“ä½œæ 
                    Row({ space: 75 }) {

                      Text(this.likesClicked ? `ğŸ‘ ç‚¹èµ${post.likes}` : `ğŸ‘ ç‚¹èµ${post.likes}`)
                        .fontColor('#666666')
                        .fontSize(13)
                        .onClick(() => {
                          if(!this.likesClicked) // åˆ‡æ¢çŠ¶æ€
                          {
                            post.likes+=1
                            this.likesClicked=!this.likesClicked
                          }
                          else{
                            post.likes-=1
                            this.likesClicked=!this.likesClicked
                          }

                        })
                      Text(`ğŸ’¬ è¯„è®º${post.comments}`).fontColor('#666666').fontSize(13)
                      Text('â†— åˆ†äº«').fontColor('#666666').fontSize(13)
                    }.margin({ top: 8 })
                  }
                  .padding(12)
                  .backgroundColor('#F9F9F9')
                  .borderRadius(16)
                  .shadow({ radius: 2, color: '#22000000', offsetX: 0, offsetY: 2 })

                  .alignItems(HorizontalAlign.Start)
                })
              }
              .width('100%')
              .padding({ top: 10, bottom: 20 })
            }
            .width('95%')
            .height('100%')
          }
          .width('95%')
          .height(612)
          .borderRadius(25)
          .backgroundColor(Color.White)
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Start)
          .margin({ top: -10 })



        }
        else if (this.currentTab === 'profile') {
          Column() {

            Column() {
              if (this.isEditing){
                Row({ space: 10 }) {  // æ°´å¹³å¹¶æ’ï¼Œé—´è· 10
                  Image($r(this.headImage))  // æ˜¾ç¤ºå½“å‰å¤´åƒï¼ˆä¸å†æœ‰ onClickï¼‰
                    .width(100)
                    .height(100)
                    .borderRadius(50)

                  Button("ä¿®æ”¹å¤´åƒ")  // æ–°æŒ‰é’®
                    .width(80)
                    .height(40)
                    .borderRadius(8)
                    .fontSize(10)
                    .fontColor(Color.White)
                    .backgroundColor("#007AFF")  // è“è‰²èƒŒæ™¯ï¼Œå¯è‡ªå®šä¹‰
                    .onClick(async () => {
                      await this.pickImageFromGallery();  // ç‚¹å‡»è°ƒç”¨é€‰æ‹©å‡½æ•°
                    })
                }
                .margin({ top: -190 })  // æ•´ä½“ä¸Šç§»
              }
              else
              {
                Image($r('app.media.head'))  // å¤´åƒèµ„æº
                  .width(100)
                  .height(100)
                  .borderRadius(50)  // åœ†å½¢
                  .margin({ top: -190 })
              }
              if (this.isEditing) {
                TextInput()

                  .width(200)
                  .height(40)
                  .fontSize(22)
                  .fontColor(Color.Black)
                  .onChange((value) => {
                    this.userName = value
                  })
                  .margin({ top: 10 })
              }
              else
              {
                Text(this.userName?this.userName:"é»˜è®¤ç”¨æˆ·")
                  .fontSize(22)
                  .fontColor(Color.Black)
                  .margin({ top: 10 })
              }



              // 4ï¸âƒ£ è“æ¡†ç™½å­—â€œç¼–è¾‘â€æŒ‰é’®
               Text(this.isEditing ? "ä¿å­˜" : "ç¼–è¾‘")
                .fontSize(18)
                .fontColor(Color.White)
                .width(120)
                .height(40)
                .borderRadius(20)
                .backgroundColor(this.isEditing ?'#FF0000':'#007AFF')
                .textAlign(TextAlign.Center)

                .margin({ top: 20 })
                 .onClick(async () => {
                   if (this.isEditing) {
                     const currentContext = this.getUIContext().getHostContext() as common.UIAbilityContext;


                     const userInfo = await loadUserInfo(currentContext);
                     const userId: number = parseInt(userInfo.id, 10) || 0;  // è½¬å› number

                     if (!userId) {
                       console.error("æœªç™»å½•æˆ–ç”¨æˆ·IDä¸¢å¤±");
                       return;
                     }
                     const httpRequest: http.HttpRequest = http.createHttp();

                     const response = await httpRequest.request(
                       "http://10.205.218.246:8080/api/updateName",
                       {
                         method: http.RequestMethod.POST,
                         header: { "Content-Type": "application/json" },
                         extraData: {
                           id: String(userId),
                           name: this.userName
                         }
                       }
                     )
                     console.log("è¯·æ±‚å‚æ•°:", JSON.stringify({ id: String(userId), name: this.userName }));

                     let text = typeof response.result === "string"
                       ? response.result
                       : new util.TextDecoder("utf-8").decode(response.result as Uint8Array)

                     const data: UpdateNameResponse = JSON.parse(text) as UpdateNameResponse;

                     if (data.success) {
                       await saveUserName(this.userName, currentContext);
                     }
                     console.log("è¿”å›ç»“æœ:", text);
                     httpRequest.destroy()
                   }

                   this.isEditing = !this.isEditing
                 })

              Row({ space: 30}) {
                Column() {
                  Text("å…³æ³¨").fontSize(16).fontColor(Color.Gray)
                  Text("0").fontSize(18).fontColor(Color.Black)
                }

                Column() {
                  Text("ç²‰ä¸").fontSize(16).fontColor(Color.Gray)
                  Text("0").fontSize(18).fontColor(Color.Black)
                }
              }
              .margin({ top: 10 })
            }
            .width('95%')
            .height('calc(115% - 100px)')
            .borderRadius(25)
            .backgroundColor(Color.White)
            .alignItems(HorizontalAlign.Center)
            .justifyContent(FlexAlign.Center)
            .margin({ top: 30 })




          }
        }
        else if (this.currentTab === 'forum') {
          Column() {
            Text("æ‰€æœ‰çš„å§")
              .fontSize(27)
              .fontColor(Color.Black)
              .margin({ top: 10, bottom: 10 })

            // ä½¿ç”¨ Scroll åŒ…è£¹æ•´ä¸ªå§åˆ—è¡¨
            // ä½¿ç”¨ Scroll åŒ…è£¹æ•´ä¸ªå§åˆ—è¡¨
            Scroll() {
              Column({ space: 16 }) {
                ForEach(this.forums, (forum: ForumItem) => {
                  Row() {
                    // å§å¤´åƒ
                    Image(forum.icon)
                      .width(70)
                      .height(70)
                      .borderRadius(12)
                      .margin({ right: 12 })

                    // å§æ–‡å­—ä¿¡æ¯
                    Column({ space: 4 }) {
                      Text(forum.baname)
                        .fontSize(18)
                        .fontColor(Color.Black)
                        .fontWeight(FontWeight.Medium)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })

                      Text(`${forum.posts} å¸–å­ Â· ${forum.members} æˆå‘˜`)
                        .fontSize(14)
                        .fontColor('#666666')
                    }
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Start)
                    .width('100%')
                  }
                  .width('92%')
                  .height(90)
                  .padding({ left: 12, right: 12 })
                  .backgroundColor(Color.White)
                  .borderRadius(14)
                  .shadow({ radius: 3, color: '#22000000', offsetX: 0, offsetY: 2 })
                  .onClick(() => {

                    // è·³è½¬åˆ°å§è¯¦æƒ…é¡µé€»è¾‘
                  })
                })
              }
              .padding({ top: 10, left: 16, right: 16, bottom: 16 })
            }
            .width('100%')
            .height('100%')
            .backgroundColor('#F5F5F5')



          }
        }



        if (this.currentTab === 'post'){
          Column({ space: 20 }) {
            // é¡¶éƒ¨æ ‡é¢˜
            Text('å‘å¸ƒå¸–å­')
              .fontSize(25)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.Black)
              .margin({ top: 20 })

            // å†…å®¹è¾“å…¥æ¡†
            TextInput({ placeholder: 'è¯·è¾“å…¥å¸–å­å†…å®¹...' })
              .width('90%')
              .height(100)
              .border({ width: 1, color: '#CCCCCC' })
              .padding(10)
              .fontSize(16)
              .onChange((val) => this.content = val)

            // é€‰æ‹©å›¾ç‰‡åŒºåŸŸ
            Column() {
              if (this.selectedImage !== '') {
                Image(this.selectedImage)
                  .width(100)
                  .height(100)
                  .borderRadius(12)
                  //.objectFit('cover')
              } else {
                Text('+')
                  .fontSize(40)
                  .fontColor('#AAAAAA')
              }
            }

              .width(100)
              .height(100)
              .border({ width: 1, color: '#CCCCCC' })
              .borderRadius(12)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .backgroundColor('#F5F5F5')
            .onClick(async () => {
              await this.pickImageForPost();
            })


            // é€‰æ‹©çš„å§
            Text('é€‰æ‹©çš„å§')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.Black)
              .margin({ top: 10, bottom: 5 })

            // å§åˆ—è¡¨
            Scroll() {
              Row({ space: 10 }) {
                ForEach(this.forums, (item: ForumItem) => {
                  Column() {
                    Image(item.icon)
                      .width(50)
                      .height(50)
                      .borderRadius(25)
                    Text(item.baname)
                      .fontSize(14)
                      .fontColor(Color.Black)
                      .margin({ top: 4 })
                  }
                  .width(100)
                  .height(100)
                  .border({
                    width: 2,
                    color: this.selectedBa === item.baname ? '#3B82F6' : '#CCCCCC'
                  })
                  .borderRadius(12)
                  .alignItems(HorizontalAlign.Center)
                  .justifyContent(FlexAlign.Center)
                  .onClick(() => {
                    this.selectedBa = item.baname
                  })
                })
              }.margin({ bottom: 20 })
            }
            .scrollable(ScrollDirection.Horizontal)
            // å‘å¸ƒæŒ‰é’®
            Button('å‘å¸ƒ')
              .width('90%')
              .height(45)
              .borderRadius(8)
              .backgroundColor(
                this.content.length > 0 && this.selectedBa !== ''
                  ? '#3B82F6'
                  : '#A0C4FF'
              )
              .fontColor(Color.White)
              .fontSize(18)
              .onClick(async () => {
                if (this.content.length === 0 || this.selectedBa === '') return

                // è°ƒç”¨åç«¯ API
                try {
                  await this.onPublishClick()
                } catch (err) {
                  console.error('å‘å¸ƒå¤±è´¥', err);
                }

              })

          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .padding(20)
        }


        if (this.currentTab === 'message'){

        }




      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)

      Row() {
        Column() {
          Text("é¦–é¡µ").fontSize(27).fontColor(this.currentTab === 'home' ? '#007AFF' : Color.Black)
            .onClick(() => {
              this.currentTab = 'home'
            })
        }

        Column() {
          Text("è¿›å§").fontSize(27).fontColor(this.currentTab === 'forum' ? '#007AFF' : Color.Black)
            .onClick(() => {
              this.currentTab = 'forum'
            })
        }

        Column() {
          Text("å‘å¸ƒ").fontSize(27).fontColor(this.currentTab === 'post' ? '#007AFF' : Color.Black)
            .onClick(() => {
              this.currentTab = 'post'
            })
        }

        Column() {
          Text("æ¶ˆæ¯").fontSize(27).fontColor(this.currentTab === 'message' ? '#007AFF' : Color.Black)
            .onClick(() => {
              this.currentTab = 'massage'
            })
        }

        Column() {
          Text("æˆ‘çš„").fontSize(27).fontColor(this.currentTab === 'profile' ? '#007AFF' : Color.Black)
            .onClick(() => {
              this.currentTab = 'profile'
            })
        }
      }
      .width('100%')
      .height(70)
      .backgroundColor('#F5F5F5')
      .justifyContent(FlexAlign.SpaceAround)
      .margin({top:850})
    }
    .width('100%')
    .height('80%')

  }

}

